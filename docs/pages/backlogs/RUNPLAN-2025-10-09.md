### Run Plan — 2025-10-09 (Profiles, Chat Owner, Moderation Policy)

## Scope
Deliver the MVP for user profiles, chat ownership, and a policy-driven moderation skeleton that can run in the prototype and migrate to LIVE.

## Step 1 — Storage Interface & Adapters
- Implement `js/state/storage.js` with final API and two drivers:
  - `localAdapter` (prototype) — default
  - `remoteAdapter` (LIVE) — stub with TODOs, same interface
- Add config switch `window.__cfg.STORAGE_DRIVER`
- Add `migrateLocalToRemote()` skeleton (no-op in prototype)

## Step 2 — Schemas
- `js/types/schemas.js`: `isUserProfile`, `isChatMeta`, constants (defaults)
- Include `profiles_version = 1`

## Step 3 — Profile Store + Seed
- `js/state/profileStore.js`: CRUD, `profiles:changed` event
- Seed with 2–4 example personas for testing

## Step 4 — Profile Form (UI)
- `js/ui/profileForm.js`: MVP form (name, language, formality, traits[], tone_pref?, conflict_avoidant?, notes?)
- Validation via schemas; writes via profileStore
- Auto-refresh on `profiles:changed`

## Step 5 — Chat Meta + Owner Logic
- `js/state/chatMeta.js`: hold owner/type/goal/languages
- `js/logic/chatOwner.js`: `ensureOwnerOnFirstUser()`, `transferOwnership(newOwnerId)`, owner-only `startIntro()` stub
- Emit `chatmeta:changed`

## Step 6 — Moderation Skeleton (policy-driven)
- `js/moderation/policies.js`: map profile traits → policy (tone, safety, style, languages)
- `js/moderation/promptBuilder.js`: build strict prompt + JSON schema
- `js/moderation/contextAdapter.js`: select relevant history
- `js/moderation/orchestrator.js`: tie together, *no real API call yet*, return dry-run object

## Step 7 — App Boot Integration
- `js/app/boot.js`: wire modules; subscribe to events; `seedIfEmpty()`
- `script.js`: thin entry calling `boot()`

## Step 8 — Docs & Checks
- Save/update docs:
  - **SCRIPT_ARCHITECTURE.md** (this architecture)
  - **DATA_STORAGE_CONCEPT.md** (storage plan)
- Quick smoke test: create/edit profiles, owner auto-assign, policy dry-run

## Deliverables
- Working profile CRUD & owner assignment
- Policy skeleton returning deterministic JSON
- Docs: architecture + storage
